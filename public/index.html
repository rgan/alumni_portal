<head>
    <script type="text/javascript" src="javascripts/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="javascripts/jquery.tmpl.js"></script>
    <script type="text/javascript" src="javascripts/knockout-1.2.1.js"></script>
    <script type="text/javascript" src="javascripts/specialities.js"></script>
    <script type="text/javascript" src="javascripts/countries.js"></script>
</head>
<body>
<h2>Alumni Portal</h2>

<div id="form">
    <p>First name:<input size=40 data-bind="value: model.first_name"></span></p>

    <p>Last name:<input size=40 data-bind="value: model.last_name"></span></p>

    <p>UG college:<input size=40 data-bind="value: model.ug_college"></span></p>

    <p>PG college:<input size=40 data-bind="value: model.pg_college"></span></p>

    <p>Speciality:
        <select data-bind="options:specialities, value: model.specialty"> </select>&nbsp;<span>Sub-Speciality:
    <select height="5" data-bind="options:sub_specialities, value: model.sub_specialty"> </select></span></p>

    <p>City:<input size=40 data-bind="value: model.address.city"></span></p>
    <p>Country:
        <select data-bind="options:countries, value: model.address.country"> </select></p>

    <button data-bind="click: addAlumnus">Save</button>
</div>

<div id="search">Enter text to search across all fields:<input size="40" id="searchText">
    <button data-bind="click:searchAlumni">Search</button>

    <div data-bind="template: { name:'alumniTemplate', data: alumni}">
    </div>

</div>

<script id="alumniTemplate" type="text/html">
    <h4>Results:</h4>
    <table width="100%">
        <tr>
            <td>First Name</td>
            <td>Last Name</td>
            <td>Specialty</td>
            <td>Sub specialty</td>
            <td>City/Town</td>
            <td>Country</td>
            <td>UG College</td>
            <td>PG College</td>
        </tr>
        {{each $data}}
        <tr>
            <td>${first_name}</td>
            <td>${last_name}</td>
            <td>${specialty}</td>
            <td>${sub_specialty}</td>
            <td>${address.city}</td>
            <td>${address.country}</td>
            <td>${ug_college}</td>
            <td>${pg_college}</td>
        </tr>
        {{/each}}
    </table>
</script>

<script type="text/javascript">
    var alumnus = {
        first_name : ko.observable(""),
        last_name : ko.observable(""),
        ug_college : ko.observable(""),
        pg_college : ko.observable(""),
        specialty : ko.observable(""),
        sub_specialty : ko.observable(""),
        address: {
            city: ko.observable(""),
            country: ko.observable("")
        },
        clear:
                function() {
                    this.first_name("");
                    this.last_name("");
                    this.ug_college("");
                    this.pg_college("");
                    this.specialty("");
                    this.address.city("");
                    this.address.country();
                }
    }

    var viewModel = {
        model : alumnus,
        addAlumnus: function() {
            $.ajax({
                url: "alumni.json",
                type: "post",
                data: ko.utils.stringifyJson({ "alumnus" : JSON.parse(ko.toJSON(this.model)) }), // this is needed because ko.toJS() does not seem to work
                contentType: "application/json",
                success: function(result) {
                    viewModel.model.clear();
                }
            });
        }
    };

    viewModel.specialities = ko.observableArray(getSpecialties());

    viewModel.sub_specialities = ko.dependentObservable(function() {
                return getSubSpecialities(this.model.specialty())
            },
            viewModel);

    var searchViewModel = {
        alumni: ko.observableArray([])
    };

    searchViewModel.searchAlumni = function() {
        searchViewModel.alumni.removeAll()
        $.ajax({
            url: "/alumni/search/" + $("input[id='searchText']").val() + ".json",
            type: "get",
            contentType: "application/json",
            success: function(result) {
                result.forEach(function(item) {
                    searchViewModel.alumni.push(item);
                });
            }
        });
    };

    ko.applyBindings(viewModel, $("#form")[0]);
    ko.applyBindings(searchViewModel, $("#search")[0]);

</script>
</body>